{% extends "layout.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1 class="display-5">
            <i class="fas fa-stream me-2"></i>Cultural Trend Dashboard
        </h1>
        <p class="lead">All trending topics from Google Trends, Reddit, and manual entries in one place.</p>
    </div>
</div>

<!-- Top Opportunities Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-primary">
            <div class="card-header bg-primary text-white">
                <h3 class="mb-0"><i class="fas fa-lightbulb me-2"></i>Top Opportunities This Week</h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <h5 class="card-title">Key Insights</h5>
                        <ul class="list-group list-group-flush mb-3">
                            {% if trends and trends|length > 0 %}
                                {% set top_trends = trends|sort(attribute='popularity_score', reverse=true)|list %}
                                {% set recent_trends = trends|sort(attribute='popularity_score', reverse=true)|list %}
                                
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <span class="badge bg-primary rounded-pill me-2">1</span>
                                        <strong>Current hottest trend:</strong> 
                                        <a href="/trend/1">{{ top_trends[0].trend_name }}</a>
                                    </div>
                                    <span class="badge bg-success rounded-pill">
                                        {% if top_trends[0].popularity_score > 0 %}
                                            Score: {{ top_trends[0].popularity_score }}
                                        {% else %}
                                            Trending
                                        {% endif %}
                                    </span>
                                </li>

                                {% if trends|length > 1 %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <span class="badge bg-primary rounded-pill me-2">2</span>
                                        <strong>Latest emerging trend:</strong> 
                                        <a href="/trend/2">{{ top_trends[1].trend_name }}</a>
                                    </div>
                                    <span class="badge bg-info rounded-pill">New</span>
                                </li>
                                {% endif %}
                                
                                {% if trends|length > 2 %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <span class="badge bg-primary rounded-pill me-2">3</span>
                                        <strong>Growing potential:</strong> 
                                        <a href="/trend/3">{{ top_trends[2].trend_name }}</a>
                                    </div>
                                    <span class="badge bg-warning text-dark rounded-pill">Pop potential</span>
                                </li>
                                {% endif %}
                            {% else %}
                                <li class="list-group-item">
                                    <div class="text-center text-muted">
                                        <i class="fas fa-info-circle me-2"></i>No trend data available yet. Try refreshing the page.
                                    </div>
                                </li>
                            {% endif %}
                        </ul>
                    </div>
                    <div class="col-md-4">
                        <h5 class="card-title">Action Items</h5>
                        <div class="d-grid gap-2">
                            <button id="refresh-trends-btn" class="btn btn-primary" onclick="refreshTrends()">
                                <i class="fas fa-sync-alt me-2"></i>Refresh Trends
                            </button>
                            <a href="/trend/1" class="btn btn-outline-primary">
                                <i class="fas fa-chart-line me-2"></i>Analyze Top Trend
                            </a>
                            <a href="{{ url_for('manual_entry') }}" class="btn btn-outline-success">
                                <i class="fas fa-plus-circle me-2"></i>Add New Observation
                            </a>
                        </div>
                    </div>
                </div>
                <div class="text-muted mt-2">
                    <small><i class="fas fa-clock me-1"></i>Last updated: {{ now.strftime('%Y-%m-%d %H:%M') }}</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Stats cards -->
<div class="row mb-4">
    <div class="col-md-4 mb-3">
        <div class="card trend-card bg-gradient bg-light shadow-sm">
            <div class="card-body text-center">
                <h3 class="card-title">
                    <i class="fab fa-google text-primary me-2"></i>Google Trends
                </h3>
                <p class="display-4">{{ trends|selectattr('source', 'equalto', 'Google Trends')|list|length }}</p>
                <p class="card-text">Latest trending topics from Google</p>
                <a href="{{ url_for('google_trends') }}" class="btn btn-outline-info">View Details</a>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card trend-card bg-gradient bg-light shadow-sm">
            <div class="card-body text-center">
                <h3 class="card-title">
                    <i class="fab fa-reddit-alien text-danger me-2"></i>Reddit Trends
                </h3>
                <p class="display-4">{{ trends|selectattr('source')|selectattr('source', 'defined')|rejectattr('source', 'equalto', 'Google Trends')|list|length }}</p>
                <p class="card-text">Top posts from monitored subreddits</p>
                <a href="{{ url_for('reddit_trends') }}" class="btn btn-outline-danger">View Details</a>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card trend-card bg-gradient bg-light shadow-sm">
            <div class="card-body text-center">
                <h3 class="card-title">
                    <i class="fas fa-edit text-success me-2"></i>Manual Entries
                </h3>
                <p class="display-4">{{ trends|selectattr('source', 'defined')|rejectattr('source', 'equalto', 'Google Trends')|rejectattr('source', 'in', ['Reddit - r/popculturechat', 'Reddit - r/AskTikTok', 'Reddit - r/femalefashionadvice', 'Reddit - r/internetisbeautiful'])|list|length }}</p>
                <p class="card-text">Manually tracked cultural trends</p>
                <a href="{{ url_for('manual_entry') }}" class="btn btn-outline-success">Add New</a>
            </div>
        </div>
    </div>
</div>

<!-- Category filters -->
<div class="row mb-3">
    <div class="col">
        <h4>Filter by Category</h4>
        <div class="category-filters">
            <button class="btn btn-sm btn-outline-secondary filter-btn active" data-filter="all">All</button>
            <button class="btn btn-sm btn-outline-secondary filter-btn" data-filter="Entertainment">Entertainment</button>
            <button class="btn btn-sm btn-outline-secondary filter-btn" data-filter="Shopping">Shopping</button>
            <button class="btn btn-sm btn-outline-secondary filter-btn" data-filter="Pop Culture">Pop Culture</button>
            <button class="btn btn-sm btn-outline-secondary filter-btn" data-filter="Social Media">Social Media</button>
            <button class="btn btn-sm btn-outline-secondary filter-btn" data-filter="TV/Film">TV/Film</button>
            <button class="btn btn-sm btn-outline-secondary filter-btn" data-filter="Product">Product</button>
            <button class="btn btn-sm btn-outline-secondary filter-btn" data-filter="Meme">Meme</button>
            <button class="btn btn-sm btn-outline-secondary filter-btn" data-filter="Aesthetic">Aesthetic</button>
            <button class="btn btn-sm btn-outline-secondary filter-btn" data-filter="Event">Event</button>
        </div>
    </div>
</div>

<!-- Unified trends table -->
<div class="row">
    <div class="col">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="mb-0">All Trends</h4>
                    <small class="text-muted"><i class="fas fa-info-circle me-1"></i>Click any trend name to view detailed context & analysis</small>
                </div>
                <a href="{{ url_for('manual_entry') }}" class="btn btn-primary btn-sm">
                    <i class="fas fa-plus me-1"></i>Add New Trend
                </a>
            </div>
            <div class="alert alert-info m-3">
                <i class="fas fa-lightbulb me-2"></i>
                <strong>Pro Tip:</strong> Each trend has a detailed analysis page showing context, time-based data, and content recommendations. 
                <span class="d-block mt-1 ms-4">Click on any trend name in the table below to see its full analysis.</span>
                
                <div class="mt-3">
                    <strong>Quick Access Links to Top Trend Analysis:</strong>
                    <div class="btn-group mt-2">
                        {% set max_buttons = 5 %}
                        {% for i in range(1, (trends|length + 1) if trends|length < max_buttons else max_buttons + 1) %}
                            <a href="/simple-trend/{{ i }}" class="btn btn-outline-primary me-2">
                                Trend #{{ i }}
                            </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
            <div class="card-body">
                {% if trends %}
                <div class="table-responsive">
                    <table class="table table-hover" id="trends-table">
                        <thead>
                            <tr>
                                <th>Trend Name</th>
                                <th>Source</th>
                                <th>Category</th>
                                <th>Popularity Score</th>
                                <th>Lifecycle Stage</th>
                                <th>Pop Potential</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for trend in trends %}
                            <tr class="trend-row" data-trend-name="{{ trend.trend_name }}" data-trend-source="{{ trend.source }}">
                                <td>
                                    <a href="/simple-trend/{{ loop.index }}" class="text-decoration-none text-dark">
                                        {{ trend.trend_name }}
                                    </a>
                                </td>
                                <td>
                                    {% if 'Google' in trend.source %}
                                    <span class="badge source-badge-google">{{ trend.source }}</span>
                                    {% elif 'Reddit' in trend.source %}
                                    <span class="badge source-badge-reddit">{{ trend.source }}</span>
                                    {% else %}
                                    <span class="badge source-badge-manual">{{ trend.source }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ trend.category }}</td>
                                <td>
                                    {% if trend.popularity_score > 0 %}
                                        {{ trend.popularity_score }}
                                    {% else %}
                                        <span class="text-muted">N/A</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if trend.lifecycle_stage != 'Unknown' %}
                                        {{ trend.lifecycle_stage }}
                                    {% else %}
                                        <span class="text-muted">Unknown</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if trend.pop_potential != 'Unknown' %}
                                        {% if trend.pop_potential == 'Yes' %}
                                        <span class="badge bg-success">Yes</span>
                                        {% else %}
                                        <span class="badge bg-secondary">No</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted">Unknown</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>No trend data available yet. Try refreshing or adding manual trends.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function refreshTrends() {
        const btn = document.getElementById('refresh-trends-btn');
        const originalHtml = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Loading...';
        
        fetch('/fetch-trends', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error refreshing trends: ' + (data.error || 'Unknown error'));
                    btn.disabled = false;
                    btn.innerHTML = originalHtml;
                }
            })
            .catch(error => {
                alert('Error refreshing trends: ' + error);
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            });
    }

    document.querySelectorAll('.nav-link, .btn').forEach(link => {
        if (!link.classList.contains('filter-btn') && link.id !== 'refresh-trends-btn') {
            link.addEventListener('click', function() {
                const overlay = document.getElementById('loading-overlay');
                if (overlay) overlay.classList.remove('d-none');
            });
        }
    });
    
    document.querySelectorAll('.trend-row').forEach(row => {
        row.addEventListener('click', function(e) {
            if (e.target.tagName !== 'A') {
                e.preventDefault();
                const trendName = this.getAttribute('data-trend-name');
                const trendSource = this.getAttribute('data-trend-source');
                const allRows = Array.from(document.querySelectorAll('.trend-row'));
                const index = allRows.indexOf(this) + 1;
                window.location.href = `/simple-trend/${index}`;
            }
        });
    });
</script>
{% endblock %}
